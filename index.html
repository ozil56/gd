<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>æ¼è›‹è®°åˆ†å™¨ Â· ç²¾ç®€ç‰ˆ</title>
<style>
  :root{
    --bg: #fff7ed;          /* æŸ”å’ŒèƒŒæ™¯ */
    --card: #ffffff;        /* å¡ç‰‡åº•è‰² */
    --text: #111827;        /* ä¸»æ–‡æœ¬ */
    --muted:#6b7280;        /* æ¬¡æ–‡æœ¬ */
    --brand:#dc2626;        /* å“ç‰Œçº¢ */
    --ok:#16a34a;           /* ç»¿è‰² */
    --warn:#f59e0b;         /* æ©™è‰² */
    --info:#2563eb;         /* è“è‰² */
    --shadow: 0 6px 18px rgba(17,24,39,0.08);
    --radius: 14px;
    --gap: 10px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    background: linear-gradient(135deg,#fff5f5 0%, var(--bg) 100%);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    color: var(--text);
    overflow: hidden; /* ä¸»ç•Œé¢ä¸æ»šåŠ¨ */
  }

  /* æ•´ä½“é‡‡ç”¨å•å±ç½‘æ ¼å¸ƒå±€ï¼Œä¿è¯æ‰‹æœºä¸€å±å±•ç¤º */
  .container{
    height: 100vh;
    max-width: 420px;
    margin: 0 auto;
    padding: 10px;
    display: grid;
    grid-template-rows: auto auto 1fr auto;
    gap: var(--gap);
  }

  .topbar{
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px 12px;
    display:flex; align-items:flex-start; gap:12px;
    flex-wrap:wrap;
  }
  .title{display:flex; align-items:center; gap:8px; font-weight:800; color:var(--brand)}
  .title .emoji{font-size:20px}
  .session-info{
    display:flex;
    flex-direction:column;
    gap:2px;
    font-size:12px;
    color:var(--muted);
    min-width:160px;
  }
  .session-info .game-id{font-weight:600; color:var(--text);}
  .session-info .status{padding:0; box-shadow:none; background:transparent;}
  .session-info .status[data-tone="error"]{color:var(--brand);}
  .session-info .status[data-tone="warn"]{color:var(--warn);}
  .session-info .status[data-tone="ok"]{color:var(--ok);}
  .session-info .status[data-tone="sync"]{color:var(--info);}
  .top-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
  .btn{
    border:0; border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer;
    background:#f3f4f6; color:#111827;
  }
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .btn.primary{background: var(--info); color:white}
  .btn.danger{background:#ef4444; color:white}
  .btn.ghost{background:#f3f4f6}
  .btn.warn{background: var(--warn); color:#111827}

  /* ç‰Œé¢åŒºï¼šä¸¤è¡Œï¼Œæ¯è¡Œä¸€é˜Ÿï¼šå·¦ç‰Œå³æŒ‰é’® */
  .board{
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px;
    display: grid;
    grid-template-rows: 1fr 1fr;
    gap: 8px;
  }

  .row{
    display:grid;
    grid-template-columns: 1fr 44%;
    gap: 10px;
    align-items: center;
  }

  .card{
    position:relative;
    background: white;
    border: 3px solid #e5e7eb;
    border-radius: 14px;
    padding: 10px;
    display:flex; align-items:center; justify-content:space-between;
    min-height: 84px;
  }
  .card.a{border-color:#dbeafe} /* Aé˜Ÿè“è¾¹ */
  .card.b{border-color:#fee2e2} /* Bé˜Ÿçº¢è¾¹ */

  .left{
    display:flex; align-items:center; gap:8px;
  }
  .badge{
    font-size:12px; font-weight:800; padding:2px 6px; border-radius:999px; background:#f3f4f6; color:#374151;
  }
  .dealer{background: #fde68a; color:#92400e;}
  .level{
    font-size:28px; font-weight:900; line-height:1;
  }
  .suit{font-size:18px; opacity:.8}
  .meta{
    display:flex; flex-direction:column; gap:2px; font-size:12px; color:var(--muted);
  }
  .meta .fails{font-weight:700; color:#ef4444}

  .crown{
    position:absolute; top:-12px; left:50%; transform:translateX(-50%);
    font-size:20px; display:none;
  }
  .card.dealing .crown{display:block}

  /* å³ä¾§æŒ‰é’®æ ˆ */
  .btns{
    display:grid; gap:8px;
  }
  .winbtn{
    width:100%; padding:12px; border:0; border-radius:12px; font-weight:900; cursor:pointer;
    background:#111827; color:white; box-shadow: var(--shadow);
  }
  .winbtn.green{background: var(--ok)}
  .winbtn.orange{background: var(--warn)}
  .winbtn.red{background: #ef4444}
  .winbtn:disabled{opacity:.5; cursor:not-allowed}

  /* åº•éƒ¨å·¥å…·æ¡ï¼ˆæ’¤å› + çŠ¶æ€ï¼‰ */
  .toolbar{
    display:flex; gap:8px; align-items:center; justify-content:space-between;
  }
  .undo{
    flex: 1;
    background: #111827; color:white; font-weight:900; padding:12px; border-radius:12px; border:0; box-shadow:var(--shadow);
  }
  .status{
    background: var(--card); border-radius:12px; padding:8px 10px; box-shadow:var(--shadow);
    font-size:12px; color:var(--muted);
  }

  /* è·èƒœæ¨ªå¹…ï¼ˆç»ˆå±€ï¼‰ */
  .winner{
    position: fixed; inset: 0; background: rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; padding: 16px;
  }
  .winner .sheet{
    width: 100%; max-width: 420px; background:linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
    border-radius: 16px; color:white; text-align:center; padding: 24px; box-shadow:var(--shadow);
  }
  .winner h2{margin:0 0 6px 0; font-size:28px}
  .winner p{margin:0 0 14px 0}
  .winner .close{background:white; color:#111827; border:0; border-radius:10px; padding:10px 14px; font-weight:800}

  /* å†å²è®°å½•å¼¹å±‚ï¼ˆä¸å ä¸»å±é«˜åº¦ï¼‰ */
  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:flex-end}
  .overlay .panel{
    width:100%; max-width:420px; margin:0 auto; background:var(--card); border-radius:16px 16px 0 0;
    padding:12px; box-shadow:var(--shadow); max-height:70vh; overflow:auto;
  }
  .overlay header{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
  .history-list{list-style:none; margin:0; padding:0; display:grid; gap:8px}
  .history-item{
    background:#f9fafb; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center;
  }
  .tag{font-size:12px; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; margin-left:6px}
  .note{font-size:12px; color:#6b7280}

  /* è¾…åŠ©ï¼šå°å±è¿›ä¸€æ­¥å‹ç¼© */
  @media (max-width:360px){
    .level{font-size:24px}
    .winbtn{padding:10px}
    .undo{padding:10px}
  }
</style>
</head>
<body>
  <div class="container">
    <!-- é¡¶éƒ¨æ  -->
    <div class="topbar">
      <div class="title"><span class="emoji">ğŸ´</span>æ¼è›‹è®°åˆ†å™¨</div>
      <div class="session-info">
        <div class="game-id">ç‰Œå±€IDï¼š<span id="gameIdDisplay">åŠ è½½ä¸­â€¦</span></div>
        <div class="status" id="syncStatus" data-tone="sync">åŒæ­¥ä¸­â€¦</div>
      </div>
      <div class="top-actions">
        <button class="btn ghost" id="btnCopyLink">å¤åˆ¶é“¾æ¥</button>
        <button class="btn warn" id="btnNewGame">æ–°ç‰Œå±€</button>
        <button class="btn ghost" id="btnHistory">å†å²</button>
        <button class="btn danger" id="btnReset">é‡ç½®</button>
      </div>
    </div>

    <!-- ç‰Œé¢ + æ“ä½œ -->
    <div class="board" id="board">
      <!-- Aé˜Ÿ -->
      <div class="row">
        <div class="card a" id="cardA">
          <div class="crown">ğŸ‘‘</div>
          <div class="left">
            <div class="level" id="lvA">2</div>
            <div class="suit">â™¥</div>
          </div>
          <div class="meta">
            <span id="infoA">è·Aè¿˜å·® 12 çº§</span>
            <span class="fails" id="failA">A1å¤±è´¥ï¼š0/3</span>
          </div>
          <span class="badge">Aé˜Ÿ</span>
        </div>
        <div class="btns">
          <button class="winbtn green"  id="btnA12">Aé˜Ÿ Â· ä¸€äºŒï¼ˆ+3ï¼‰</button>
          <button class="winbtn orange" id="btnA13">Aé˜Ÿ Â· ä¸€ä¸‰ï¼ˆ+2ï¼‰</button>
          <button class="winbtn red"    id="btnA14">Aé˜Ÿ Â· ä¸€å››ï¼ˆ+1ï¼‰</button>
        </div>
      </div>
      <!-- Bé˜Ÿ -->
      <div class="row">
        <div class="card b" id="cardB">
          <div class="crown">ğŸ‘‘</div>
          <div class="left">
            <div class="level" id="lvB">2</div>
            <div class="suit">â™ </div>
          </div>
          <div class="meta">
            <span id="infoB">è·Aè¿˜å·® 12 çº§</span>
            <span class="fails" id="failB">A1å¤±è´¥ï¼š0/3</span>
          </div>
          <span class="badge">Bé˜Ÿ</span>
        </div>
        <div class="btns">
          <button class="winbtn green"  id="btnB12">Bé˜Ÿ Â· ä¸€äºŒï¼ˆ+3ï¼‰</button>
          <button class="winbtn orange" id="btnB13">Bé˜Ÿ Â· ä¸€ä¸‰ï¼ˆ+2ï¼‰</button>
          <button class="winbtn red"    id="btnB14">Bé˜Ÿ Â· ä¸€å››ï¼ˆ+1ï¼‰</button>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å·¥å…·æ¡ -->
    <div class="toolbar">
      <button class="undo" id="btnUndo" disabled>æ’¤å›ä¸Šä¸€æ­¥</button>
      <div class="status">
        <div id="dealerText">å½“å‰åº„å®¶ï¼šæš‚æ— </div>
      </div>
    </div>

    <!-- ç»ˆå±€æ¨ªå¹… -->
    <div class="winner" id="winner">
      <div class="sheet">
        <h2 id="winnerText">æŸé˜Ÿè·èƒœï¼</h2>
        <p>æœ¬å±€ç»“æŸï¼Œå¯åœ¨ä¸Šæ–¹â€œæ’¤å›ä¸Šä¸€æ­¥â€ä¿®æ­£è¯¯æ“ä½œã€‚</p>
        <button class="close" id="closeWinner">ç»§ç»­æŸ¥çœ‹</button>
      </div>
    </div>

    <!-- å†å²è®°å½•å¼¹å±‚ -->
    <div class="overlay" id="historyOverlay">
      <div class="panel">
        <header>
          <strong>å¯¹å±€å†å²</strong>
          <div>
            <button class="btn ghost" id="btnExport">å¯¼å‡ºJSON</button>
            <button class="btn" id="btnCloseHistory">å…³é—­</button>
          </div>
        </header>
        <ul class="history-list" id="historyList"></ul>
      </div>
    </div>
  </div>

<script>
/* ===================== åŸºæœ¬å¸¸é‡ ===================== */
const LEVELS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
const MAX_INDEX = 12; // 'A'
const APPLY_WINNER_DELTA_EVEN_IF_OPP_AT_A = true; // è‹¥å¸Œæœ›åˆ°Aååªåˆ¤åº„å®¶ï¼Œä¸å†æ¶¨çº§ï¼Œæ”¹ä¸º false
const API_BASE = '/api/games.asp';

let currentGameId = null;
let isReady = false;
let statusClearTimer = null;

/* ===================== çŠ¶æ€åŠæŒä¹…åŒ– ===================== */
function freshState(){
  const now = new Date().toISOString();
  return {
    aLevel: 0, // index in LEVELS
    bLevel: 0,
    dealer: null, // 'A' | 'B' | null
    a1Fails: { A:0, B:0 }, // ä»…åœ¨â€œåº„å®¶åœ¨Aä¸”è¾“â€æ—¶ç´¯è®¡ï¼›åˆ°3å›2å¹¶æ¸…é›¶
    history: [],           // [{winner:'A'|'B', delta:1|2|3, pattern:'ä¸€å››'ç­‰, notes:[], ts:number}]
    gameOver: false,
    meta: {
      id: null,
      createdAt: now,
      updatedAt: now
    }
  };
}

function hydrateState(remoteState, id){
  const base = freshState();
  const incoming = (remoteState && typeof remoteState === 'object') ? remoteState : {};
  const merged = Object.assign({}, base, incoming);
  merged.a1Fails = Object.assign({}, base.a1Fails, incoming.a1Fails || {});
  merged.history = Array.isArray(incoming.history) ? incoming.history.map(item => ({...item})) : [];
  merged.meta = Object.assign({}, base.meta, incoming.meta || {});
  if(id) merged.meta.id = id;
  if(!merged.meta.createdAt) merged.meta.createdAt = base.meta.createdAt;
  if(!merged.meta.updatedAt) merged.meta.updatedAt = merged.meta.createdAt;
  return merged;
}

let state = freshState();

/* ===================== ç½‘ç»œä¸åŒæ­¥ ===================== */
async function apiFetchGame(id){
  const res = await fetch(`${API_BASE}?id=${encodeURIComponent(id)}`);
  if(res.status === 404){
    const err = new Error('NOT_FOUND');
    err.code = 'NOT_FOUND';
    throw err;
  }
  if(!res.ok){
    throw new Error('FETCH_FAILED');
  }
  return res.json();
}

async function apiCreateGame(initialState){
  const res = await fetch(`${API_BASE}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ state: initialState })
  });
  if(!res.ok){
    throw new Error('CREATE_FAILED');
  }
  return res.json();
}

async function apiUpdateGame(id, nextState){
  const res = await fetch(`${API_BASE}?id=${encodeURIComponent(id)}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ state: nextState })
  });
  if(!res.ok){
    throw new Error('SAVE_FAILED');
  }
  return res.json();
}

function updateUrlWithId(id){
  if(!id) return;
  const url = new URL(window.location.href);
  url.searchParams.set('id', id);
  window.history.replaceState(null, '', url);
}

function updateGameIdDisplay(){
  const display = document.getElementById('gameIdDisplay');
  if(display){
    if(currentGameId){
      display.textContent = currentGameId;
    }else if(!isReady){
      display.textContent = 'åŠ è½½ä¸­â€¦';
    }else{
      display.textContent = 'â€”';
    }
  }
  if(currentGameId){
    document.title = `æ¼è›‹è®°åˆ†å™¨ Â· #${currentGameId}`;
  }else if(isReady){
    document.title = 'æ¼è›‹è®°åˆ†å™¨ Â· æœªç¼–å·';
  }else{
    document.title = 'æ¼è›‹è®°åˆ†å™¨';
  }
}

function showStatus(message, tone='info'){
  const statusEl = document.getElementById('syncStatus');
  if(!statusEl) return;
  statusEl.textContent = message || '';
  if(tone){
    statusEl.setAttribute('data-tone', tone);
  }else{
    statusEl.removeAttribute('data-tone');
  }
  if(statusClearTimer){
    clearTimeout(statusClearTimer);
    statusClearTimer = null;
  }
  if(tone === 'ok'){
    statusClearTimer = setTimeout(()=>{
      if(statusEl.getAttribute('data-tone') === 'ok'){
        statusEl.textContent = '';
        statusEl.removeAttribute('data-tone');
      }
    }, 2000);
  }
}

async function persistState(){
  if(!isReady || !currentGameId) return;
  state.meta = Object.assign({}, state.meta || {}, {
    id: currentGameId,
    updatedAt: new Date().toISOString()
  });
  try{
    showStatus('åŒæ­¥ä¸­â€¦', 'sync');
    await apiUpdateGame(currentGameId, state);
    showStatus('å·²ä¿å­˜', 'ok');
  }catch(err){
    console.error('ä¿å­˜å¤±è´¥', err);
    showStatus('åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
  }
}

function buildShareLink(){
  const url = new URL(window.location.href);
  if(currentGameId){
    url.searchParams.set('id', currentGameId);
  }
  return url.toString();
}

async function copyShareLink(){
  if(!currentGameId) return;
  const text = buildShareLink();
  try{
    await navigator.clipboard.writeText(text);
    showStatus('é“¾æ¥å·²å¤åˆ¶', 'ok');
  }catch(err){
    console.warn('Clipboard å¤åˆ¶å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æç¤ºæ¡†', err);
    window.prompt('æ‰‹åŠ¨å¤åˆ¶é“¾æ¥', text);
  }
}

async function createNewGameFromUI(){
  const confirmMsg = 'åˆ›å»ºæ–°ç‰Œå±€å°†ç”Ÿæˆæ–°çš„ç‰Œå±€IDï¼Œå½“å‰æ•°æ®ä¸ä¼šè‡ªåŠ¨ä¿ç•™ã€‚ç»§ç»­å—ï¼Ÿ';
  if(!window.confirm(confirmMsg)) return;
  const initial = freshState();
  try{
    showStatus('åˆ›å»ºæ–°ç‰Œå±€ä¸­â€¦', 'sync');
    const created = await apiCreateGame(initial);
    currentGameId = created.id;
    state = hydrateState(created.state || initial, currentGameId);
    updateUrlWithId(currentGameId);
    isReady = true;
    updateUI();
    showStatus('å·²åˆ›å»ºæ–°ç‰Œå±€', 'ok');
  }catch(err){
    console.error('åˆ›å»ºæ–°ç‰Œå±€å¤±è´¥', err);
    showStatus('åˆ›å»ºæ–°ç‰Œå±€å¤±è´¥', 'error');
  }
}

async function initialize(){
  const params = new URLSearchParams(window.location.search);
  const requestedId = params.get('id');
  let loaded = false;
  showStatus('åŠ è½½ä¸­â€¦', 'sync');
  try{
    if(requestedId){
      const remote = await apiFetchGame(requestedId);
      currentGameId = remote.id || requestedId;
      state = hydrateState(remote.state, currentGameId);
      updateUrlWithId(currentGameId);
      showStatus('ç‰Œå±€å·²åŠ è½½', 'ok');
    }else{
      const initial = freshState();
      const created = await apiCreateGame(initial);
      currentGameId = created.id;
      state = hydrateState(created.state || initial, currentGameId);
      updateUrlWithId(currentGameId);
      showStatus('å·²åˆ›å»ºæ–°ç‰Œå±€', 'ok');
    }
    loaded = true;
  }catch(err){
    if(err && err.code === 'NOT_FOUND'){
      try{
        const initial = freshState();
        const created = await apiCreateGame(initial);
        currentGameId = created.id;
        state = hydrateState(created.state || initial, currentGameId);
        updateUrlWithId(currentGameId);
        showStatus('æŒ‡å®šç‰Œå±€ä¸å­˜åœ¨ï¼Œå·²åˆ›å»ºæ–°ç‰Œå±€', 'warn');
        loaded = true;
      }catch(inner){
        console.error('è‡ªåŠ¨åˆ›å»ºæ–°ç‰Œå±€å¤±è´¥', inner);
        showStatus('æ— æ³•åˆ›å»ºæ–°ç‰Œå±€ï¼Œè¯·ç¨åå†è¯•', 'error');
      }
    }else{
      console.error('åŠ è½½ç‰Œå±€å¤±è´¥', err);
      showStatus('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨ååˆ·æ–°', 'error');
    }
  }
  isReady = loaded;
  updateUI();
}

/* ===================== å·¥å…·å‡½æ•° ===================== */
function el(id){ return document.getElementById(id); }
function teamLevel(team){ return team==='A' ? state.aLevel : state.bLevel; }
function setTeamLevel(team, idx){ if(team==='A') state.aLevel = idx; else state.bLevel = idx; }
function clampA(idx){ return Math.min(MAX_INDEX, Math.max(0, idx)); }
function isDealerAtA(){ return state.dealer && teamLevel(state.dealer) === MAX_INDEX; }

/* å°†ä¸€æ‰‹å¯¹å±€åº”ç”¨åˆ°å½“å‰çŠ¶æ€ï¼ˆæ ¸å¿ƒè§„åˆ™ï¼‰ */
function applyRoundCore(winner, delta, pattern, collectNotes=true){
  const entry = { winner, delta, pattern, notes: [], ts: Date.now() };
  const loser = (winner === 'A' ? 'B' : 'A');

  let skipWinnerDeltaThisRound = false; // æŸäº›æƒ…å½¢ï¼ˆç¬¬3æ¬¡Aä¸è¿‡å›2ï¼‰éœ€è¦è·³è¿‡æœ¬æ‰‹ç»™èµ¢å®¶åŠ çº§

  // â€”â€”A é˜¶æ®µç‰¹æ®Šåˆ¤å®šï¼šä»…å½“â€œåº„å®¶åœ¨Aâ€æ—¶ä»‹å…¥ï¼ˆä¿æŒä½ åŸæœ‰ç»“æ„ä¸å˜ï¼‰â€”â€”
  if (isDealerAtA()) {
    if (state.dealer === winner) {
      // åº„å®¶åœ¨Aä¸”èµ¢
      if (delta >= 2) {
        // ä¸€äºŒ / ä¸€ä¸‰ æ‰ç®—â€œè¿‡Aâ€ -> ç»ˆå±€ï¼ˆä¸ä½ åŸé€»è¾‘ä¸€è‡´ï¼Œä½†æ”¶ç´§æ¡ä»¶ï¼‰
        entry.notes.push('åº„å®¶åœ¨Aä¸”èµ¢ï¼ˆè¿‡Aï¼‰ï¼šæ•´å±€ç»“æŸ');
        state.gameOver = true;
        state.history.push(entry);
        state.dealer = winner; // è®°è´¦ä¸€è‡´
        return;
      } else {
        // delta===1 -> ä¸€å››ï¼šèµ¢ä½†æœªè¿‡Aï¼Œè®°Aä¸è¿‡ï¼ˆA1å¤±è´¥ï¼‰+1ï¼Œç»§ç»­æ‰“A
        state.a1Fails[state.dealer] = (state.a1Fails[state.dealer] || 0) + 1;
        entry.notes.push(`${state.dealer} åœ¨Aèµ¢â€œä¸€å››â€æœªè¿‡ï¼šA1å¤±è´¥ï¼ˆ${state.a1Fails[state.dealer]}/3ï¼‰`);
        if (state.a1Fails[state.dealer] >= 3) {
          // ç¬¬3æ¬¡ä½œä¸ºåº„å®¶æ‰“Aä¸è¿‡ -> å›åˆ°2ï¼Œå¹¶æ¸…é›¶è®¡æ•°
          setTeamLevel(state.dealer, 0);
          entry.notes.push(`${state.dealer} ç¬¬3æ¬¡A1å¤±è´¥ï¼šå›åˆ°2`);
          state.a1Fails[state.dealer] = 0;
          // è‹¥æœ¬æ‰‹èµ¢å®¶æ­£æ˜¯è¯¥åº„å®¶ï¼Œä¸ºä¿æŒâ€œå›åˆ°2â€çš„è½ç‚¹ï¼Œæœ¬æ‰‹ä¸å†ç»™å…¶åŠ çº§
          skipWinnerDeltaThisRound = true;
        }
      }
    } else {
      // åº„å®¶åœ¨Aä¸”è¾“ -> è®°Aä¸è¿‡ï¼ˆA1å¤±è´¥ï¼‰+1ï¼Œè¾¾åˆ°3æ¬¡å›åˆ°2ï¼ˆä¿æŒä½ åŸé€»è¾‘ï¼‰
      state.a1Fails[state.dealer] = (state.a1Fails[state.dealer] || 0) + 1;
      entry.notes.push(`${state.dealer} åœ¨Aå¤±åˆ©ï¼šA1å¤±è´¥ï¼ˆ${state.a1Fails[state.dealer]}/3ï¼‰`);
      if (state.a1Fails[state.dealer] >= 3) {
        setTeamLevel(state.dealer, 0);
        entry.notes.push(`${state.dealer} ç¬¬3æ¬¡A1å¤±è´¥ï¼šå›åˆ°2`);
        state.a1Fails[state.dealer] = 0;
      }
    }
  }

  // â€”â€”å¸¸è§„åŠ çº§ï¼šåªç»™èµ¢å®¶æ¶¨çº§ï¼ˆå°é¡¶Aï¼‰ã€‚æ˜¯å¦åœ¨Aé˜¶æ®µä»åŠ çº§ç”±ä½ åŸæ¥çš„å¼€å…³æ§åˆ¶â€”â€”
  const winnerAtA = (teamLevel(winner) === MAX_INDEX);
  const loserAtA  = (teamLevel(loser)  === MAX_INDEX);
  const shouldApply =
    APPLY_WINNER_DELTA_EVEN_IF_OPP_AT_A ? true : (!winnerAtA && !loserAtA);

  if (!skipWinnerDeltaThisRound && shouldApply) {
    const newIdx = clampA(teamLevel(winner) + delta);
    setTeamLevel(winner, newIdx);
  }

  // åº„å®¶æ›´æ–°ä¸ºæœ¬æ‰‹èµ¢å®¶ï¼ˆä¿æŒåŸè§„åˆ™ï¼šä¸Šä¸€æŠŠèµ¢çš„ååº„ï¼‰
  state.dealer = winner;

  // è®°å½•å†å²
  state.history.push(entry);
}

/* æ’¤å›ï¼šå›æ”¾å†å²é‡ç®— */
function recomputeFromHistory(){
  const snapshot = state.history.map(x => ({winner:x.winner, delta:x.delta, pattern:x.pattern}));
  const previousMeta = state.meta;
  state = freshState();
  state.meta = Object.assign({}, state.meta, previousMeta || {});
  state.meta.id = currentGameId;
  for(const h of snapshot){
    applyRoundCore(h.winner, h.delta, h.pattern);
    if(state.gameOver) break; // è‹¥æŸä¸€æ­¥å°±ç»ˆå±€ï¼Œåé¢æœ¬ä¸åº”å­˜åœ¨ï¼Œä½†ç¨³å¦¥å¤„ç†
  }
}

/* ===================== äº‹ä»¶å¤„ç† ===================== */
function record(winner, delta, pattern){
  if(!isReady || state.gameOver) return;
  applyRoundCore(winner, delta, pattern);
  state.meta.updatedAt = new Date().toISOString();
  updateUI();
  persistState();
}
function undo(){
  if(!isReady || state.history.length === 0) return;
  state.history.pop();
  recomputeFromHistory();
  state.meta.updatedAt = new Date().toISOString();
  updateUI();
  persistState();
}
function resetAll(){
  if(!isReady) return;
  if(!confirm('ç¡®å®šè¦é‡ç½®æœ¬å±€æ‰€æœ‰æ•°æ®å—ï¼Ÿï¼ˆäº‘ç«¯å­˜æ¡£ä¹Ÿä¼šæ¸…ç©ºï¼‰')) return;
  const previousMeta = state.meta;
  state = freshState();
  state.meta = Object.assign({}, state.meta, previousMeta || {});
  state.meta.id = currentGameId;
  state.meta.updatedAt = new Date().toISOString();
  updateUI();
  persistState();
}

/* ===================== UI æ¸²æŸ“ ===================== */
function updateUI(){
  updateGameIdDisplay();
  // ç‰Œå€¼
  el('lvA').textContent = LEVELS[state.aLevel];
  el('lvB').textContent = LEVELS[state.bLevel];
  // æç¤º
  el('infoA').textContent = (state.aLevel===MAX_INDEX) ? 'å·²åœ¨ A' : `è·Aè¿˜å·® ${MAX_INDEX - state.aLevel} çº§`;
  el('infoB').textContent = (state.bLevel===MAX_INDEX) ? 'å·²åœ¨ A' : `è·Aè¿˜å·® ${MAX_INDEX - state.bLevel} çº§`;
  el('failA').textContent = `A1å¤±è´¥ï¼š${state.a1Fails.A||0}/3`;
  el('failB').textContent = `A1å¤±è´¥ï¼š${state.a1Fails.B||0}/3`;

  // åº„å®¶æ ‡è¯†
  el('dealerText').textContent = 'å½“å‰åº„å®¶ï¼š' + (state.dealer ? (state.dealer+'é˜Ÿ') : 'æš‚æ— ');
  el('cardA').classList.toggle('dealing', state.dealer==='A');
  el('cardB').classList.toggle('dealing', state.dealer==='B');

  // æŒ‰é’®å¯ç”¨æ€§
  const disabled = (!isReady) || state.gameOver;
  ['btnA12','btnA13','btnA14','btnB12','btnB13','btnB14'].forEach(id=>{
    el(id).disabled = disabled;
  });
  // æ’¤å›æ˜¯å¦å¯ç”¨
  el('btnUndo').disabled = (!isReady) || state.history.length===0;
  const allowActions = !!isReady;
  if(el('btnReset')) el('btnReset').disabled = !allowActions;
  if(el('btnHistory')) el('btnHistory').disabled = !allowActions;
  if(el('btnCopyLink')) el('btnCopyLink').disabled = (!allowActions) || !currentGameId;

  // ç»ˆå±€æ¨ªå¹…
  const winnerLayer = el('winner');
  if(state.gameOver){
    const text = (state.dealer ? `${state.dealer}é˜Ÿ èƒœï¼` : 'ç»ˆå±€');
    el('winnerText').textContent = text;
    winnerLayer.style.display = 'flex';
  }else{
    winnerLayer.style.display = 'none';
  }

  // å†å²åˆ—è¡¨ï¼ˆå¼¹å±‚é‡Œï¼‰
  const list = el('historyList');
  list.innerHTML = '';
  state.history.forEach((h, i)=>{
    const li = document.createElement('li');
    li.className = 'history-item';
    const left = document.createElement('div');
    left.innerHTML = `<strong>#${i+1}</strong> <span class="tag">${h.winner}é˜Ÿ ${h.pattern} +${h.delta}</span>`;
    const right = document.createElement('div');
    right.className = 'note';
    right.textContent = (h.notes && h.notes.length) ? h.notes.join('ï¼›') : '';
    li.appendChild(left); li.appendChild(right);
    list.appendChild(li);
  });
}

/* ===================== ç»‘å®šäº‹ä»¶ ===================== */
el('btnA12').addEventListener('click',()=>record('A',3,'ä¸€äºŒ'));
el('btnA13').addEventListener('click',()=>record('A',2,'ä¸€ä¸‰'));
el('btnA14').addEventListener('click',()=>record('A',1,'ä¸€å››'));

el('btnB12').addEventListener('click',()=>record('B',3,'ä¸€äºŒ'));
el('btnB13').addEventListener('click',()=>record('B',2,'ä¸€ä¸‰'));
el('btnB14').addEventListener('click',()=>record('B',1,'ä¸€å››'));

el('btnUndo').addEventListener('click', undo);
el('btnReset').addEventListener('click', resetAll);

el('btnCopyLink').addEventListener('click', ()=>{ if(!isReady || !currentGameId) return; copyShareLink(); });
el('btnNewGame').addEventListener('click', ()=>{ createNewGameFromUI(); });
el('btnHistory').addEventListener('click', ()=>{ if(!isReady) return; el('historyOverlay').style.display='flex'; });
el('btnCloseHistory').addEventListener('click', ()=>{ el('historyOverlay').style.display='none'; });
el('btnExport').addEventListener('click', ()=>{
  const data = JSON.stringify(state, null, 2);
  // ç®€æ˜“ä¸‹è½½
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `guandan-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

el('closeWinner').addEventListener('click', ()=>{ el('winner').style.display='none'; });

/* ===================== é¦–æ¬¡æ¸²æŸ“ ===================== */
updateUI();
initialize();
</script>
</body>
</html>
